window.__require=function e(t,n,i){function o(s,c){if(!n[s]){if(!t[s]){var u=s.split("/");if(u=u[u.length-1],!t[u]){var a="function"==typeof __require&&__require;if(!c&&a)return a(u,!0);if(r)return r(u,!0);throw new Error("Cannot find module '"+s+"'")}s=u}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){return o(t[s][1][e]||e)},l,l.exports,e,t,n,i)}return n[s].exports}for(var r="function"==typeof __require&&__require,s=0;s<i.length;s++)o(i[s]);return o}({Agent:[function(e,t,n){"use strict";cc._RF.push(t,"8acaf8DBERMuLzuB557wttG","Agent"),Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Ann"),o=function(){function e(){this.brain=null,this.genome=null,this.species=null,this.fitness=0}return e.create=function(t){return(new e).reset(t)},e.prototype.reset=function(e){return this.brain?this.brain.build(e):this.brain=i.default.create(e),this.genome=e,this.species=null,this.fitness=0,this},e.prototype.react=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return this.brain?(e=this.brain).feed.apply(e,t):[]},e}();n.default=o,cc._RF.pop()},{"./Ann":"Ann"}],Ann:[function(e,t,n){"use strict";cc._RF.push(t,"c627295DQBLUYU6mjdZQgHc","Ann"),Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){this.inputNodes=[],this.hiddenNodes=[],this.outputNodes=[]}return e.create=function(t){return(new e).build(t)},e.prototype.build=function(e){return this.setConnections(this.setNodes(e),e)},e.prototype.feed=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=[];return e.length===this.inputNodes.length&&(this.inputNodes.forEach(function(e){return e.clearResult()}),this.hiddenNodes.forEach(function(e){return e.clearResult()}),this.outputNodes.forEach(function(e){return e.clearResult()}),this.inputNodes.forEach(function(t,n){t.hasResult=!0,t.value=e[n]}),this.outputNodes.forEach(function(e){n.push(e.getResult())})),n},e.prototype.setNodes=function(e){var t,n=e.inputNum,i=e.inputNum+e.outputNum,r=new Map;(function(e){e[e.inputNode=1]="inputNode",e[e.outputNode=2]="outputNode",e[e.hiddenNode=3]="hiddenNode"})(t||(t={})),this.inputNodes.length=0,this.hiddenNodes.length=0,this.outputNodes.length=0;for(var s=0,c=e.nodes;s<c.length;s++){var u,a=c[s].uid,l=t.hiddenNode;switch(a<=i&&(l=a<=n?t.inputNode:t.outputNode),u=o.create(l!==t.inputNode),r.set(a,u),l){case t.inputNode:this.inputNodes.push(u);break;case t.outputNode:this.outputNodes.push(u);break;case t.hiddenNode:this.hiddenNodes.push(u)}}return r},e.prototype.setConnections=function(e,t){for(var n=0,i=t.connections;n<i.length;n++){var o=i[n];if(!0===o.enabled){var r=e.get(o.to.uid),s=e.get(o.from.uid);r&&s&&(r.inputs.push(s),r.weights.push(o.weight))}}return this},e}();n.default=i;var o=function(){function e(){this.inputs=null,this.weights=null,this.hasResult=!1,this.value=0}return e.create=function(t){void 0===t&&(t=!0);var n=new e;return!0===t&&(n.inputs=[],n.weights=[]),n},e.prototype.getResult=function(){var e=this.inputs,t=this.weights;if(!0===this.hasResult)return this.value;if(!e||!t)return this.hasResult=!0,this.value;if(e.length!==t.length)return this.hasResult=!1,this.value;for(var n=0,i=0,o=t.length;i<o;++i)n+=t[i]*e[i].getResult();return this.hasResult=!0,this.value=this.activate(n),this.value},e.prototype.clearResult=function(){this.hasResult=!1,this.value=0},e.prototype.activate=function(e){return e>=0?e:.07*e},e}();cc._RF.pop()},{}],Ga:[function(e,t,n){"use strict";cc._RF.push(t,"37861VN57hIP4EbclzMe3Wi","Ga"),Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Neat"),o=e("./Species"),r=function(){function e(){}return e.nextEpochForSingleSpecies=function(t,n){void 0===n&&(n=!1);for(var i=[],o=t[0],r=t[1],s=t[2],c=0,u=t;c<u.length;c++){var a=u[c],l=t[e.getRouletteNum(t.length-1)],h=l.fitness>a.fitness,p=a.genome.crossover(l.genome,h);p.mutate(n),i.push(p)}i[Math.max(0,i.length-3)]=s.genome.clone(),i[Math.max(0,i.length-2)]=r.genome.clone(),i[Math.max(0,i.length-1)]=o.genome.clone(),t.forEach(function(e,t){e.reset(i[t])})},e.nextEpochForMutipleSpecies=function(t,n){if(void 0===n&&(n=!1),!(t.length<=1)){var r=t.length,s=[],c=t[0],u=t[1],a=t[2];s.push(o.default.create(c));for(var l=1;l<r;++l){for(var h=!1,p=0,f=s;p<f.length;p++)if((w=f[p]).try2Put(t[l])){h=!0;break}!1===h&&s.push(o.default.create(t[l]))}for(s.forEach(function(e){return e.evaluateScore()}),s.forEach(function(e){return e.kill(i.default.speciesSurviveRate)}),l=s.length-1;l>=0;--l)s[l].agents.length<=1&&(s[l].dieOut(),s.splice(l,1));if(s.length<=1)e.nextEpochForSingleSpecies(t,n);else{var d=0,v=[];s.forEach(function(e){return d+=e.score}),s.sort(function(e,t){return t.score-e.score});for(var g=0,m=t;g<m.length;g++){var N=m[g];if(N.species){var y=(T=(w=N.species).agents[e.getRouletteNum(w.agents.length-1)]).fitness>N.fitness;(P=N.genome.crossover(T.genome,y)).mutate(n),v.push(P)}else{var T,P,w=null,S=Math.random(),_=0;if(d>0)for(var b=0,M=s;b<M.length;b++){var x=M[b];if(S<=(_+=x.score)/d){w=x;break}}else w=s[Math.floor(S*s.length)];if(null!==w)y=(T=w.agents[e.getRouletteNum(w.agents.length-1)]).fitness>N.fitness,(P=N.genome.crossover(T.genome,y)).mutate(n),v.push(P)}}v[Math.max(0,v.length-3)]=a.genome.clone(),v[Math.max(0,v.length-2)]=u.genome.clone(),v[Math.max(0,v.length-1)]=c.genome.clone(),t.forEach(function(e,t){e.reset(v[t])})}}},e.getRouletteNum=function(e){var t=i.default.rNormal(2);return t<.5&&(t=1-t),t=2*(t-.5),Math.floor(t*e)},e}();n.default=r,cc._RF.pop()},{"./Neat":"Neat","./Species":"Species"}],Gene:[function(e,t,n){"use strict";cc._RF.push(t,"8a9e7nwFLJFarfuT565zDFg","Gene"),Object.defineProperty(n,"__esModule",{value:!0}),n.ConnGene=n.NodeGene=void 0;var i=function(){function e(){this.uid=e.invalidID,this.x=0,this.y=0}return e.create=function(t){void 0===t&&(t=-1);var n=new e;return-1!==t&&(n.uid=t),n},e.getNode=function(t){var n=e.nodePool;return t!==e.invalidID&&n[t]?n[t]:n[0]},e.getNewNode=function(){var t=e.nodePool,n=e.create(t.length);return t.push(n),n},e.getMiddleNode=function(t){var n=e.lstMidNodes;return t!==o.invalidInnovNum&&n.has(t)?n.get(t):e.nodePool[0]},e.addMiddleNode=function(t,n){var i=e.lstMidNodes;t===o.invalidInnovNum||i.has(t)||i.set(t,n)},e.invalidID=0,e.nodePool=[e.create(e.invalidID)],e.lstMidNodes=new Map,e}();n.NodeGene=i;var o=function(){function e(){this.innovNum=e.invalidInnovNum,this.enabled=!0,this.weight=0,this.from=null,this.to=null,this.code=""}return e.create=function(t,n){var i=new e;return i.setConnection(t,n),i},e.prototype.setConnection=function(e,t){this.to=t,this.from=e,this.code=this.hash()},e.prototype.getCode=function(){return""===this.code&&(this.code=this.hash()),this.code},e.prototype.clone=function(){var t=new e;return t.setConnection(this.from,this.to),t.innovNum=this.innovNum,t.enabled=this.enabled,t.weight=this.weight,t},e.prototype.hash=function(){return this.from&&this.to?"{"+this.from.uid+", "+this.to.uid+"}":"invalid-code"},e.getInnovNum=function(t){var n=e.lstInnovNums;return n.has(t)?n.get(t):e.invalidInnovNum},e.addInnovNum=function(t){if("invalid-code"!==t){var n=e.lstInnovNums;n.has(t)||n.set(t,e.nextInnovNum++)}},e.getLatestInnovNum=function(){return e.nextInnovNum-1},e.invalidInnovNum=0,e.nextInnovNum=1,e.lstInnovNums=new Map,e}();n.ConnGene=o,cc._RF.pop()},{}],Genome:[function(e,t,n){"use strict";cc._RF.push(t,"2d1d8LG72tG6bvuR++fqggN","Genome"),Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Neat"),o=e("./Gene"),r=function(){function e(){this.inputNum=0,this.outputNum=0,this.nodes=[],this.connections=[]}return e.createPrototype=function(t,n){var i=new e;if(t>0&&n>0){var r=2*e.spaceHalfHeight,s=r/(t+1),c=r/(n+1);i.inputNum=t,i.outputNum=n;for(var u=1;u<=t;++u)(l=o.NodeGene.getNode(u)).uid===o.NodeGene.invalidID&&(l=o.NodeGene.getNewNode()),i.nodes.push(l),l.y=-e.spaceHalfHeight+s*u,l.x=-e.spaceHalfWidth;var a=t+n;for(u=t+1;u<=a;++u){var l;(l=o.NodeGene.getNode(u)).uid===o.NodeGene.invalidID&&(l=o.NodeGene.getNewNode()),i.nodes.push(l),l.y=-e.spaceHalfHeight+c*(u-t),l.x=e.spaceHalfWidth}}return i},e.prototype.distance=function(e){var t=e;if(this===t)return 0;for(var n,o=this.connections.length,r=0,s=t.connections.length,c=0,u=0,a=0,l=0,h=null,p=0,f=null,d=0;r<o&&c<s;)h=this.connections[r],f=t.connections[c],(p=h.innovNum)===(d=f.innovNum)?(l+=Math.abs(h.weight-f.weight),++u,++r,++c):p>d?(++a,++c):(++a,++r);u>0&&(l/=u),n=o-r+(s-c);var v=Math.max(o,s);if(v<i.default.linkEarlyProtection){var g=v/i.default.linkEarlyProtection;v=i.default.lerp(1,i.default.linkEarlyProtection,Math.pow(g,3))}return i.default.c1*n/v+i.default.c2*a/v+i.default.c3*l},e.prototype.crossover=function(t,n){var i,r,s=this,c=t;if(s===c)return this.clone();var u=s.connections.length,a=0,l=c.connections.length,h=0;if(n&&(s=(i=[c,s])[0],c=i[1],u=(r=[l,u])[0],l=r[1]),s.inputNum!==c.inputNum||s.outputNum!==c.outputNum)return this.clone();var p=new e;p.inputNum=this.inputNum,p.outputNum=this.outputNum;for(var f=null,d=0,v=null,g=0;a<u&&h<l;)f=s.connections[a],v=c.connections[h],(d=f.innovNum)===(g=v.innovNum)?(p.connections.push(Math.random()<.5?f.clone():v.clone()),++a,++h):d>g?++h:(p.connections.push(f.clone()),++a);for(;a<u;)p.connections.push(s.connections[a].clone()),++a;for(var m=new Map,N=null,y=null,T=1,P=p.inputNum+p.outputNum;T<=P;++T){var w=o.NodeGene.getNode(T);m.set(T,1),p.nodes.push(w)}for(var S=0,_=p.connections;S<_.length;S++){var b=_[S];N=b.from,y=b.to,!1===m.has(N.uid)&&(m.set(N.uid,1),p.nodes.push(N)),!1===m.has(y.uid)&&(m.set(y.uid,1),p.nodes.push(y))}return p.nodes.sort(function(e,t){return e.uid-t.uid}),p},e.prototype.clone=function(){var t=new e;return t.inputNum=this.inputNum,t.outputNum=this.outputNum,this.nodes.forEach(function(e){return t.nodes.push(e)}),this.connections.forEach(function(e){return t.connections.push(e.clone())}),t},e.prototype.mutate=function(e){var t=Math.random,n=i.default.nodeMutationProb,o=i.default.linkMutationProb,r=this.inputNum+this.outputNum;this.nodes.length-r<i.default.nodeEarlyProtection&&(n=.4),this.connections.length<Math.round(i.default.linkEarlyProtection/4)&&(o=this.connections.length>0?.2:1),!e&&t()<n&&this.mutateNode(),!e&&t()<o&&this.mutateLink(),t()<i.default.weightMutationDitherProb&&this.mutateWeightDitheringly(),t()<i.default.weightMutationRandomProb&&this.mutateWeightRandomly(),this.connections.length>=i.default.linkEarlyProtection&&t()<i.default.linkToggleMutationProb&&this.mutateLinkToggle()},e.prototype.mutateNode=function(){if(!(this.connections.length<=0))for(var t=100,n=this.connections.length-1,r=function(e){return e.innovNum===o.ConnGene.invalidInnovNum&&(o.ConnGene.addInnovNum(e.getCode()),e.innovNum=o.ConnGene.getInnovNum(e.getCode()),!0)};t>0;){var s=i.default.rInt(0,n),c=this.connections[s];if(c&&!0===c.enabled){var u=o.NodeGene.getMiddleNode(c.innovNum);if(u.uid===o.NodeGene.invalidID){var a=.1*e.spaceHalfHeight;(u=o.NodeGene.getNewNode()).x=(c.from.x+c.to.x)/2,u.y=(c.from.y+c.to.y)/2+i.default.rUnit()*a,o.NodeGene.addMiddleNode(c.innovNum,u)}var l=o.ConnGene.create(c.from,u),h=o.ConnGene.create(u,c.to);l.weight=1,l.enabled=!0,h.weight=c.weight,h.enabled=c.enabled,l.innovNum=o.ConnGene.getInnovNum(l.getCode()),h.innovNum=o.ConnGene.getInnovNum(h.getCode()),this.connections.splice(s,1),this.connections.push(l,h),!1===(r(l)&&r(h))&&this.connections.sort(function(e,t){return e.innovNum-t.innovNum});var p=this.nodes.push(u);p>=2&&this.nodes[p-2].uid>u.uid&&this.nodes.sort(function(e,t){return e.uid-t.uid});break}--t}},e.prototype.mutateLink=function(){if(!(this.nodes.length<=1))for(var e=100,t=this.nodes.length-1,n=this.inputNum+this.outputNum,r=this.inputNum,s=function(){var s,u=i.default.rInt(0,t),a=i.default.rInt(0,t);if(u===a)return"continue";if(u<r&&a<r)return"continue";if(u>=r&&u<n&&a>=r&&a<n)return"continue";var l=c.nodes[u],h=c.nodes[a];if(Math.abs(l.x-h.x)<=1e-7)return"continue";l.x>h.x&&(l=(s=[h,l])[0],h=s[1]);var p=o.ConnGene.create(l,h),f=o.ConnGene.getInnovNum(p.getCode()),d=!0;if(f!==o.ConnGene.invalidInnovNum&&(o.NodeGene.getMiddleNode(f).uid!==o.NodeGene.invalidID&&(d=!1),-1!==i.default.binarySearch(c.connections,function(e){return e.innovNum-f})&&(d=!1)),!0===d)return f===o.ConnGene.invalidInnovNum&&(o.ConnGene.addInnovNum(p.getCode()),f=o.ConnGene.getInnovNum(p.getCode())),p.weight=i.default.rUnit()*i.default.weightRandomScalar,p.enabled=!0,p.innovNum=f,c.connections.push(p),p.innovNum!==o.ConnGene.getLatestInnovNum()&&c.connections.sort(function(e,t){return e.innovNum-t.innovNum}),"break";--e},c=this;e>0&&"break"!==s(););},e.prototype.mutateWeightDitheringly=function(){var e=i.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.weight+=i.default.rUnit()*i.default.weightDitherScalar)},e.prototype.mutateWeightRandomly=function(){var e=i.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.weight=i.default.rUnit()*i.default.weightRandomScalar)},e.prototype.mutateLinkToggle=function(){var e=i.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.enabled=!t.enabled)},e.spaceHalfWidth=200,e.spaceHalfHeight=200,e}();n.default=r,cc._RF.pop()},{"./Gene":"Gene","./Neat":"Neat"}],Neat:[function(e,t,n){"use strict";var i;cc._RF.push(t,"97461zxj4dOWLQUem104tXb","Neat"),Object.defineProperty(n,"__esModule",{value:!0}),function(e){e.c1=1,e.c2=1,e.c3=1,e.cp=.3,e.speciesSurviveRate=.1,e.nodeEarlyProtection=3,e.linkEarlyProtection=20,e.weightDitherScalar=1.2,e.weightRandomScalar=.5,e.nodeMutationProb=.01,e.linkMutationProb=.015,e.linkToggleMutationProb=.001,e.weightMutationDitherProb=.8,e.weightMutationRandomProb=.4,e.rInt=function(e,t){var n;return e>t&&(e=(n=[t,e])[0],t=n[1]),Math.floor(e)+Math.floor(Math.random()*(t-e+1))},e.rUnit=function(){var e=Math.random,t=e();return 0===t?0:t<.5?e()-1:1-e()},e.rNormal=function(e){for(var t=Math.random,n=0,i=0;i<e;++i)n+=t();return n/e},e.lerp=function(e,t,n){return e+(t-e)*n},e.binarySearch=function(e,t){for(var n=0,i=0,o=0,r=e.length-1;o<=r;){if(0===(i=t(e[n=o+r>>>1])))return n;i>0?r=n-1:o=n+1}return-1}}(i||(i={})),n.default=i,cc._RF.pop()},{}],Species:[function(e,t,n){"use strict";cc._RF.push(t,"9b708ws9jVJJascTqrrLGkf","Species"),Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Neat"),o=function(){function e(){this.representative=null,this.agents=[],this.score=0}return e.create=function(t){var n=new e;return n.representative=t,n.representative.species=n,n.agents.push(t),n},e.prototype.try2Put=function(e){return e.genome.distance(this.representative.genome)<=i.default.cp&&(this.agents.push(e),e.species=this,!0)},e.prototype.dieOut=function(){for(var e=0,t=this.agents;e<t.length;e++)t[e].species=null;this.representative.species=null,this.representative=null,this.agents.length=0,this.score=0},e.prototype.evaluateScore=function(){var e=this.agents.length,t=0;if(e>0){for(var n=0,i=0,o=this.agents;i<o.length;i++)n+=o[i].fitness;t=n/e}return this.score=t,t},e.prototype.kill=function(e){for(var t=this,n=this.agents.length-1,i=Math.round(e*n),o=n;o>i;--o)this.agents.pop().species=null;this.agents.length<=0?this.dieOut():-1===this.agents.findIndex(function(e){return e===t.representative})&&(this.representative=this.agents[0])},e}();n.default=o,cc._RF.pop()},{"./Neat":"Neat"}],TetrisRenderer:[function(e,t,n){"use strict";cc._RF.push(t,"97999m4IwpKx4ONMh8aBinm","TetrisRenderer"),Object.defineProperty(n,"__esModule",{value:!0});var i=e("./Tetris"),o=cc._decorator,r=o.ccclass,s=o.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tileArea=null,t.tileFrame=null,t.previewPiece=null,t.scoreNum=null,t.lstTilePrefab=[],t.tetris=null,t.tileLines=null,t.tileNodeLines=null,t.tileNodePools=null,t.nextPieceType=-1,t.score=-1,t}return __extends(t,e),t.prototype.setTetris=function(e){this.tetris=e},t.prototype.init=function(e){this.tetris=e,this.tileLines=[],this.tileNodeLines=[],this.tileNodePools=new Map,this.tileNodePools.set(i.Tetris.eTile.Piece_1,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_2,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_3,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_4,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_5,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_6,new cc.NodePool),this.tileNodePools.set(i.Tetris.eTile.Piece_7,new cc.NodePool);for(var t=0,n=i.Tetris.heightTileNum;t<n;++t)this.tileLines.push(new Array(i.Tetris.widthTileNum).fill(i.Tetris.eTile.Empty));for(t=0,n=i.Tetris.heightTileNum;t<n;++t)this.tileNodeLines.push(new Array(i.Tetris.widthTileNum).fill(null));this.initTileArea()},t.prototype.release=function(){this.tileNodePools&&this.tileNodePools.forEach(function(e){e&&e.size()>0&&e.clear()}),this.tileFrame.destroyAllChildren(),this.previewPiece.destroyAllChildren(),this.tetris=null,this.tileLines=null,this.tileNodeLines=null,this.tileNodePools=null,this.nextPieceType=-1,this.score=-1},t.prototype.lateUpdate=function(){var e=this,t=this.tetris;if(t){var n=t.lines,o=this.tileLines;o.forEach(function(t,i){t.forEach(function(t,o){t!==n[i][o]&&e.setTileOnArea(o,i,n[i][o])})});var r=t.pieceQueue[0];if(r&&!0===r.enable){var s=i.Tetris.heightTileNum-1,c=i.Tetris.widthTileNum-1,u=r.getTilePositions(),a=r.type,l=-1,h=-1;u.forEach(function(t){l=t.x,h=t.y,l>=0&&l<=c&&h>=0&&h<=s&&o[h][l]!==a&&e.setTileOnArea(l,h,a)})}this.updatePreviewPiece(),this.updateScore()}},t.prototype.initTileArea=function(){var e=this.getTileNode(i.Tetris.eTile.Piece_1),t=i.Tetris.heightTileNum*e.height,n=i.Tetris.widthTileNum*e.width,o=cc.v2(-n/2,-t/2);e.destroy(),this.tileFrame.setPosition(o),this.tileArea.setPosition(o);for(var r=-1,s=i.Tetris.widthTileNum;r<=s;++r)for(var c=-1,u=i.Tetris.heightTileNum;c<=u;c+=u+1)(e=this.getTileNode(0)).setPosition(cc.v2(r*e.width,c*e.height)),e.setParent(this.tileFrame);for(r=-1,s=i.Tetris.widthTileNum;r<=s;r+=s+1)for(c=-1,u=i.Tetris.heightTileNum;c<=u;++c)(e=this.getTileNode(0)).setPosition(cc.v2(r*e.width,c*e.height)),e.setParent(this.tileFrame)},t.prototype.setTileOnArea=function(e,t,n){var o=this.tileLines,r=this.tileNodeLines,s=i.Tetris.eTile.Empty,c=o[t][e];if(c!==s&&(this.setTileNode2Pool(c,r[t][e]),r[t][e]=null),n!==s){var u=this.getTileNode(n);u.setPosition(cc.v2(e*u.width,t*u.height)),u.setParent(this.tileArea),r[t][e]=u}o[t][e]=n},t.prototype.updatePreviewPiece=function(){var e=this,t=this.tetris;if(t){var n=t.pieceQueue.find(function(e){return!1===e.enable});if(n){if(this.nextPieceType!==n.type){this.nextPieceType=n.type,this.previewPiece.destroyAllChildren();var o=i.Piece.create().reset(n.type),r=n.getTilePositions(),s=-1,c=-1;r.forEach(function(t){s=t.x,c=t.y;var n=e.getTileNode(o.type);n.setPosition(cc.v2(s*n.width,c*n.height)),n.setParent(e.previewPiece)})}}else this.nextPieceType=i.Tetris.eTile.Empty,this.previewPiece.destroyAllChildren()}},t.prototype.updateScore=function(){var e=this.tetris;e&&this.score!==e.score&&(this.scoreNum.string="Score: "+e.score,this.score=e.score)},t.prototype.getTileNode=function(e){if(e<i.Tetris.eTile.Piece_1&&(e=0),e>i.Tetris.eTile.Piece_7&&(e=0),this.tileNodePools){var t=this.tileNodePools.get(e);if(t&&t.size()>0)return t.get()}return cc.instantiate(this.lstTilePrefab[e])},t.prototype.setTileNode2Pool=function(e,t){if(this.tileNodePools){var n=this.tileNodePools.get(e);if(n&&n.size()<30)return n.put(t),!0}return t.destroy(),!1},__decorate([s(cc.Node)],t.prototype,"tileArea",void 0),__decorate([s(cc.Node)],t.prototype,"tileFrame",void 0),__decorate([s(cc.Node)],t.prototype,"previewPiece",void 0),__decorate([s(cc.Label)],t.prototype,"scoreNum",void 0),__decorate([s([cc.Prefab])],t.prototype,"lstTilePrefab",void 0),__decorate([r],t)}(cc.Component);n.default=c,cc._RF.pop()},{"./Tetris":"Tetris"}],TetrisTest:[function(e,t,n){"use strict";cc._RF.push(t,"3da015Q4tZGe43ZG09abj2g","TetrisTest"),Object.defineProperty(n,"__esModule",{value:!0});var i,o=e("./neat/Ga"),r=e("./neat/Agent"),s=e("./neat/Genome"),c=e("./tetris/Tetris"),u=e("./tetris/TetrisRenderer");(function(e){e[e.SingleSpecies=1]="SingleSpecies",e[e.MutipleSpecies=2]="MutipleSpecies"})(i||(i={}));var a=cc._decorator,l=a.ccclass,h=a.property,p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.pen=null,t.genText=null,t.speedUpBtn=null,t}return __extends(t,e),t.prototype.onLoad=function(){cc.dynamicAtlasManager.enabled=!0,cc.dynamicAtlasManager.textureSize=1024,cc.dynamicAtlasManager.maxAtlasCount=1},t.prototype.start=function(){this.TetrisTest(i.MutipleSpecies)},t.prototype.TetrisTest=function(e){var t=this;void 0===e&&(e=i.SingleSpecies);var n=[],a=1,l=!1,h=c.Tetris.create();h.state=c.Tetris.eState.Start;var p=cc.find("Canvas/TetrisRenderer").getComponent(u.default);p&&p.init(h);for(var f=c.Tetris.widthTileNum+4+1,d=0;d<200;++d)n.push(r.default.create(s.default.createPrototype(f,4)));n.forEach(function(e){for(var t=0;t<64;++t)e.genome.mutateLink()});var v=1,g={testFunc:null};cc.tween(this.node).delay(.5).call(function(){cc.tween(t.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){g.testFunc&&g.testFunc()}),cc.delayTime(0)))).start()}).start(),this.speedUpBtn.node.on("click",function(){if(g.testFunc)for(var e=0;e<1500;++e)g.testFunc()}),g.testFunc=function(){if(h.state!==c.Tetris.eState.Idle){if(1===v&&(t.computeFitness(h,n),n.sort(function(e,t){return t.fitness-e.fitness}),t.displayANN(n[0]),t.genText.string="Generation: "+a,v=2),2===v){if(h.state!==c.Tetris.eState.ScanLines)return void t.runGameOneStep(h,n[0]);v=3}if(3===v){switch(h.score>=3e3&&(l=!0),e){case i.SingleSpecies:o.default.nextEpochForSingleSpecies(n,l);break;case i.MutipleSpecies:o.default.nextEpochForMutipleSpecies(n,l)}v=1,a+=1}h.step()}else h.state=c.Tetris.eState.Start}},t.prototype.runGameOneStep=function(e,t){var n=e.lines,i=c.Tetris.eTile.Empty,o=t.genome.inputNum,r=new Array(o).fill(0);n.forEach(function(e,t){e.forEach(function(e,n){e!==i&&(r[n]=t+1)})});var s=e.pieceQueue[0];if(s&&!0===s.enable){var u=o-4-1;r[u]=s.x,r[u+1]=s.y,r[u+2]=s.rot,r[u+3]=s.type,r[u+4]=1}var a=t.react.apply(t,r);if(a[0]>.5)for(var l=2*(a[0]-.5),h=Math.round(cc.misc.lerp(1,5,l)),p=0;p<h;++p)c.Control.pressKeyUp(e);if(a[1]>.5&&c.Control.pressKeyDown(e),a[2]-a[3]>=.1)for(l=Math.min(a[2]-a[3],1),h=Math.round(cc.misc.lerp(1,3,l)),p=0;p<h;++p)c.Control.pressKeyLeft(e);if(a[3]-a[2]>=.1)for(l=Math.min(a[3]-a[2],1),h=Math.round(cc.misc.lerp(1,3,l)),p=0;p<h;++p)c.Control.pressKeyRight(e);e.step()},t.prototype.computeFitness=function(e,t){var n=this;t.forEach(function(t){for(var i=e.clone(),o=c.Tetris.eTile.Empty;i.state!==c.Tetris.eState.ScanLines;)n.runGameOneStep(i,t);i.lines.forEach(function(e,n){var i=c.Tetris.heightTileNum-n,r=0;e.forEach(function(e){e===o&&++r});var s=Math.pow(i,1.2);if(0===r&&(t.fitness+=1.6*(Math.pow(n,1.2)+5)),r===c.Tetris.widthTileNum)t.fitness+=1.2*(Math.pow(n,1.2)+5);else{var u=c.Tetris.widthTileNum,a=(u-r)/u;t.fitness+=2.4*Math.pow(a,2)*s}});for(var r=0,s=0,u=c.Tetris.widthTileNum;s<u;++s)for(var a=0,l=i.lines,h=c.Tetris.heightTileNum-1;h>=0;--h)l[h][s]!==o?0===a&&(a=h+1):a>0&&++r;t.fitness+=-100*r})},t.prototype.playGameTest=function(){var e=this,t=c.Tetris.create(),n=cc.find("Canvas/TetrisRenderer").getComponent(u.default);n&&n.init(t),cc.systemEvent.on("keydown",function(e){e.keyCode===cc.macro.KEY.up&&c.Control.pressKeyUp(t),e.keyCode===cc.macro.KEY.down&&c.Control.pressKeyDown(t),e.keyCode===cc.macro.KEY.left&&c.Control.pressKeyLeft(t),e.keyCode===cc.macro.KEY.right&&c.Control.pressKeyRight(t)}),cc.tween(this.node).delay(.5).call(function(){t.state=c.Tetris.eState.Start}).call(function(){cc.tween(e.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){return t.step()}),cc.delayTime(.5)))).start()}).start()},t.prototype.displayANN=function(e){var t=this.pen,n=e.genome;t.clear(),n.connections.forEach(function(e){!0===e.enabled&&(t.moveTo(e.from.x,e.from.y),t.lineTo(e.to.x,e.to.y))}),t.stroke(),n.nodes.forEach(function(e){t.circle(e.x,e.y,5)}),t.fill()},__decorate([h(cc.Graphics)],t.prototype,"pen",void 0),__decorate([h(cc.Label)],t.prototype,"genText",void 0),__decorate([h(cc.Button)],t.prototype,"speedUpBtn",void 0),__decorate([l],t)}(cc.Component);n.default=p,cc._RF.pop()},{"./neat/Agent":"Agent","./neat/Ga":"Ga","./neat/Genome":"Genome","./tetris/Tetris":"Tetris","./tetris/TetrisRenderer":"TetrisRenderer"}],Tetris:[function(e,t,n){"use strict";var i,o;cc._RF.push(t,"fa07dhbXk1HRpx7/EmLlYcI","Tetris"),Object.defineProperty(n,"__esModule",{value:!0}),n.peiceShape=n.Control=n.Piece=n.Tetris=void 0,function(e){e[e.Empty=0]="Empty",e[e.Piece_1=1]="Piece_1",e[e.Piece_2=2]="Piece_2",e[e.Piece_3=3]="Piece_3",e[e.Piece_4=4]="Piece_4",e[e.Piece_5=5]="Piece_5",e[e.Piece_6=6]="Piece_6",e[e.Piece_7=7]="Piece_7"}(i||(i={})),function(e){e[e.Idle=0]="Idle",e[e.Start=1]="Start",e[e.PieceComing=2]="PieceComing",e[e.PieceSlipping=3]="PieceSlipping",e[e.ScanLines=4]="ScanLines",e[e.GameOver=5]="GameOver"}(o||(o={}));var r=function(){function e(){this.pieceQueue=[],this.lines=new Array,this.state=e.eState.Idle,this.bag7=new Array,this.slipDown=0,this.rotTimes=0,this.shiftDir=0,this.score=0}return e.create=function(){var t=new e;return t.reset(),t},e.prototype.clone=function(){var t=new e;return this.pieceQueue.forEach(function(e){t.pieceQueue.push(e.clone())}),this.lines.forEach(function(e){t.lines.push(e.map(function(e){return e}))}),t.state=this.state,t.slipDown=this.slipDown,t.rotTimes=this.rotTimes,t.shiftDir=this.shiftDir,t.score=this.score,t},e.prototype.reset=function(){this.pieceQueue.length=0,this.lines.length=0,this.state=e.eState.Idle,this.resetPlayerOperations(),this.score=0;for(var t=0,n=e.heightTileNum;t<n;++t)this.lines.push(this.newEmptyLine());return this},e.prototype.step=function(){switch(this.state){case e.eState.Idle:break;case e.eState.Start:this.reset(),this.addPieceInQueue(),this.addPieceInQueue(),this.state=e.eState.PieceComing,this.step();break;case e.eState.PieceComing:this.initSlippingPiece(),this.resetPlayerOperations(),this.state=e.eState.PieceSlipping;break;case e.eState.PieceSlipping:var t=this.pieceQueue[0];t&&!0===t.enable&&(this.dealWithInputs(),t.slip(),!0===this.collideOrNot(t)&&(t.raise(),this.putPieceOn(t),this.removeSlippingPiece(),this.addPieceInQueue(),this.state=e.eState.ScanLines));break;case e.eState.ScanLines:var n=this.scanLines();this.score+=this.countScores(n),this.clearLines(n),!0===this.isGameOver()?this.state=e.eState.GameOver:this.state=e.eState.PieceComing,this.step();break;case e.eState.GameOver:this.state=e.eState.Idle,this.step()}},e.prototype.dealWithInputs=function(){if(this.state===e.eState.PieceSlipping){var t=this.pieceQueue[0];if(t&&!0===t.enable){for(var n=this.rotTimes%4,i=0;i<n;++i)this.try2Rotate(t);for(n=Math.min(Math.abs(this.shiftDir),Math.round(e.widthTileNum/2)),i=0;i<n;++i)this.shiftDir>0?this.try2ShiftRight(t):this.try2ShiftLeft(t);this.slipDown>=1&&(t.slip(),!0===this.collideOrNot(t)&&t.raise()),this.resetPlayerOperations()}}},e.prototype.newEmptyLine=function(){return new Array(e.widthTileNum).fill(e.eTile.Empty)},e.prototype.scanLines=function(){var t=[];return this.lines.forEach(function(n,i){-1===n.findIndex(function(t){return t===e.eTile.Empty})&&t.push(i)}),t},e.prototype.clearLines=function(e){for(var t=this,n=this.lines,i=e.length-1;i>=0;--i)n.splice(e[i],1);e.forEach(function(){n.push(t.newEmptyLine())})},e.prototype.countScores=function(t){for(var n=0,i=t.length-1,o=0;o<=i;++o)o+3<=i&&t[o]+3===t[o+3]?(n+=e.scoreTetris,o+=3):o+2<=i&&t[o]+2===t[o+2]?(n+=e.scoreTriple,o+=2):o+1<=i&&t[o]+1===t[o+1]?(n+=e.scoreDouble,o+=1):n+=e.scoreSingle;return n},e.prototype.try2Rotate=function(t){if(t.rotate(),!0===this.collideOrNot(t)){var n=t.getTilePositions(),i=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,r=t.x;return n.forEach(function(e){e.x<i&&(i=e.x),e.x>o&&(o=e.x)}),i<0&&(t.x+=Math.abs(i),!1===this.collideOrNot(t))||(o>e.widthTileNum-1&&(t.x+=o-e.widthTileNum-1,!1===this.collideOrNot(t))||(t.x=r,t.rotateUndo(),!1))}return!0},e.prototype.try2ShiftLeft=function(e){return e.shiftLeft(),!0!==this.collideOrNot(e)||(e.shiftRight(),!1)},e.prototype.try2ShiftRight=function(e){return e.shiftRight(),!0!==this.collideOrNot(e)||(e.shiftLeft(),!1)},e.prototype.collideOrNot=function(e){return e.checkCollision(this)},e.prototype.putPieceOn=function(e){e.putOn(this)},e.prototype.isGameOver=function(){return-1!==this.lines[this.lines.length-1].findIndex(function(t){return t>e.eTile.Empty})},e.prototype.initSlippingPiece=function(){var t=this.pieceQueue[0];if(t)for(t.enable=!0,t.x=Math.floor((e.widthTileNum-1)/2),t.y=e.heightTileNum-2;!0===this.collideOrNot(t);)t.y+=1},e.prototype.resetPlayerOperations=function(){this.slipDown=0,this.rotTimes=0,this.shiftDir=0},e.prototype.addPieceInQueue=function(){var t,n=s.create(),i=this.bag7;if(0===i.length){i.push(e.eTile.Piece_1),i.push(e.eTile.Piece_2),i.push(e.eTile.Piece_3),i.push(e.eTile.Piece_4),i.push(e.eTile.Piece_5),i.push(e.eTile.Piece_6),i.push(e.eTile.Piece_7);for(var o=i.length-1;o>0;o--){var r=Math.floor(Math.random()*(o+1));t=[i[r],i[o]],i[o]=t[0],i[r]=t[1]}}n.reset(i.pop()),this.pieceQueue.push(n)},e.prototype.removeSlippingPiece=function(){this.pieceQueue.length>0&&(this.pieceQueue.shift().enable=!1)},e.widthTileNum=10,e.heightTileNum=20,e.scoreSingle=40,e.scoreDouble=100,e.scoreTriple=300,e.scoreTetris=1200,e.eTile=i,e.eState=o,e}();n.Tetris=r;var s=function(){function e(){this.enable=!1,this.type=e.eTile.Empty,this.rot=0,this.x=0,this.y=0}return e.create=function(){var t=new e;return t.reset(e.eTile.Empty),t},e.prototype.clone=function(){var t=new e;return t.enable=this.enable,t.type=this.type,t.rot=this.rot,t.x=this.x,t.y=this.y,t},e.prototype.reset=function(e){return this.enable=!1,this.type=e,this.rot=0,this},e.prototype.getTilePositions=function(){var e=new Array,t=this.getPieceShape();if(t)for(var n=this.x+c.offset.x,i=this.y+c.offset.y,o=0,r=t.length;o<r;++o)for(var s=t[o],u=0,a=s.length;u<a;++u)1===s[u]&&e.push({x:n+u,y:i+o});return e},e.prototype.checkCollision=function(e){for(var t=r.heightTileNum-1,n=r.widthTileNum-1,i=r.eTile.Empty,o=e.lines,s=-1,c=-1,u=0,a=this.getTilePositions();u<a.length;u++){var l=a[u];if(s=l.x,(c=l.y)<0)return!0;if(s<0||s>n)return!0;if(c<=t&&o[c][s]!==i)return!0}return!1},e.prototype.putOn=function(e){for(var t=r.heightTileNum-1,n=r.widthTileNum-1,i=e.lines,o=this.type,s=-1,c=-1,u=0,a=this.getTilePositions();u<a.length;u++){var l=a[u];s=l.x,c=l.y,s>=0&&s<=n&&c>=0&&c<=t&&(i[c][s]=o)}},e.prototype.getPieceShape=function(){return c.shape[this.type][this.rot]},e.prototype.rotate=function(){this.rot+=1,this.rot>3&&(this.rot=0)},e.prototype.rotateUndo=function(){this.rot+=-1,this.rot<0&&(this.rot=3)},e.prototype.shiftRight=function(){this.x+=1},e.prototype.shiftLeft=function(){this.x+=-1},e.prototype.raise=function(){this.y+=1},e.prototype.slip=function(){this.y+=-1},e.eTile=i,e}();n.Piece=s;var c,u=function(){function e(){}return e.pressKeyUp=function(e){e.state===r.eState.PieceSlipping&&(e.rotTimes+=1,e.dealWithInputs())},e.pressKeyDown=function(e){e.state===r.eState.PieceSlipping?(e.slipDown=1,e.dealWithInputs()):e.state===r.eState.Idle&&(e.state=r.eState.Start)},e.pressKeyLeft=function(e){e.state===r.eState.PieceSlipping&&(e.shiftDir+=-1,e.dealWithInputs())},e.pressKeyRight=function(e){e.state===r.eState.PieceSlipping&&(e.shiftDir+=1,e.dealWithInputs())},e}();n.Control=u,function(e){e.shape=[[],[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],[[[0,0,0],[1,1,1],[1,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1,0],[0,1,0],[0,1,0]]],[[[0,0,0],[1,1,1],[0,0,1]],[[0,1,1],[0,1,0],[0,1,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[1,1,0]]],[[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]]],[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]],[[1,1,0],[0,1,1],[0,0,0]],[[0,1,0],[1,1,0],[1,0,0]]],[[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[1,1,0],[0,1,0]]],[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,0,0],[1,1,0],[0,1,0]]]],e.offset={x:-1,y:-1}}(c=n.peiceShape||(n.peiceShape={})),cc._RF.pop()},{}],XorTest:[function(e,t,n){"use strict";cc._RF.push(t,"040f0WJ7Z5JT7VesOvVB/qL","XorTest"),Object.defineProperty(n,"__esModule",{value:!0});var i,o=e("./neat/Ga"),r=e("./neat/Agent"),s=e("./neat/Genome");(function(e){e[e.SingleSpecies=1]="SingleSpecies",e[e.MutipleSpecies=2]="MutipleSpecies"})(i||(i={}));var c=cc._decorator,u=c.ccclass,a=(c.property,function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.pen=null,t}return __extends(t,e),t.prototype.onLoad=function(){cc.game.setFrameRate(50),this.pen=this.node.addComponent(cc.Graphics),this.pen.strokeColor=cc.Color.GREEN,this.pen.fillColor=cc.Color.GREEN,this.pen.lineWidth=2},t.prototype.start=function(){this.xorTest(i.MutipleSpecies)},t.prototype.xorTest=function(e){var t=this;void 0===e&&(e=i.SingleSpecies);for(var n=[],c=1,u=0;u<50;++u)n.push(r.default.create(s.default.createPrototype(2,1)));var a={testFunc:null},l=cc.tween(this.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){a.testFunc&&a.testFunc()}),cc.delayTime(0)))).start();a.testFunc=function(){for(var r=0,s=[0,0,0,0],u=0,a=n;u<a.length;u++){var h=a[u];s[0]=h.react(0,0)[0],s[1]=h.react(0,1)[0],s[2]=h.react(1,0)[0],s[3]=h.react(1,1)[0],r=0,r+=Math.pow(s[0]-0,2),r+=Math.pow(s[1]-1,2),r+=Math.pow(s[2]-1,2),r+=Math.pow(s[3]-0,2),r+=1e-7,h.fitness=1/r}n.sort(function(e,t){return t.fitness-e.fitness});var p=n[0],f=p.fitness>=1e5;if((c%10==1||f)&&(console.log("------------------------"),console.log("generation: "+c.toString()),console.log("best genome, XOR problem [0, 0 -> "+p.react(0,0)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [0, 1 -> "+p.react(0,1)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [1, 0 -> "+p.react(1,0)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [1, 1 -> "+p.react(1,1)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),t.displayANN(p)),f)return console.log("------------------------"),console.log("end."),void(l&&(l.stop(),l=null));switch(e){case i.SingleSpecies:o.default.nextEpochForSingleSpecies(n);break;case i.MutipleSpecies:o.default.nextEpochForMutipleSpecies(n)}c+=1}},t.prototype.displayANN=function(e){var t=this.pen,n=e.genome;t.clear(),n.connections.forEach(function(e){!0===e.enabled&&(t.moveTo(e.from.x,e.from.y),t.lineTo(e.to.x,e.to.y))}),t.stroke(),n.nodes.forEach(function(e){t.circle(e.x,e.y,5)}),t.fill()},__decorate([u],t)}(cc.Component));n.default=a,cc._RF.pop()},{"./neat/Agent":"Agent","./neat/Ga":"Ga","./neat/Genome":"Genome"}]},{},["TetrisTest","XorTest","Agent","Ann","Ga","Gene","Genome","Neat","Species","Tetris","TetrisRenderer"]);