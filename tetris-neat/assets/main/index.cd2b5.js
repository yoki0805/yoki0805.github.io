window.__require=function e(t,i,n){function o(s,c){if(!i[s]){if(!t[s]){var u=s.split("/");if(u=u[u.length-1],!t[u]){var a="function"==typeof __require&&__require;if(!c&&a)return a(u,!0);if(r)return r(u,!0);throw new Error("Cannot find module '"+s+"'")}s=u}var l=i[s]={exports:{}};t[s][0].call(l.exports,function(e){return o(t[s][1][e]||e)},l,l.exports,e,t,i,n)}return i[s].exports}for(var r="function"==typeof __require&&__require,s=0;s<n.length;s++)o(n[s]);return o}({Agent:[function(e,t,i){"use strict";cc._RF.push(t,"8acaf8DBERMuLzuB557wttG","Agent"),Object.defineProperty(i,"__esModule",{value:!0});var n=e("./Ann"),o=function(){function e(){this.brain=null,this.genome=null,this.species=null,this.fitness=0}return e.create=function(t){return(new e).reset(t)},e.prototype.reset=function(e){return this.brain?this.brain.build(e):this.brain=n.default.create(e),this.genome=e,this.species=null,this.fitness=0,this},e.prototype.react=function(){for(var e,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return this.brain?(e=this.brain).feed.apply(e,t):[]},e}();i.default=o,cc._RF.pop()},{"./Ann":"Ann"}],Ann:[function(e,t,i){"use strict";cc._RF.push(t,"c627295DQBLUYU6mjdZQgHc","Ann"),Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(){this.inputNodes=[],this.hiddenNodes=[],this.outputNodes=[]}return e.create=function(t){return(new e).build(t)},e.prototype.build=function(e){return this.setConnections(this.setNodes(e),e)},e.prototype.feed=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=[];return e.length===this.inputNodes.length&&(this.inputNodes.forEach(function(e){return e.clearResult()}),this.hiddenNodes.forEach(function(e){return e.clearResult()}),this.outputNodes.forEach(function(e){return e.clearResult()}),this.inputNodes.forEach(function(t,i){t.hasResult=!0,t.value=e[i]}),this.outputNodes.forEach(function(e){i.push(e.getResult())})),i},e.prototype.setNodes=function(e){var t,i=e.inputNum,n=e.inputNum+e.outputNum,r=new Map;(function(e){e[e.inputNode=1]="inputNode",e[e.outputNode=2]="outputNode",e[e.hiddenNode=3]="hiddenNode"})(t||(t={})),this.inputNodes.length=0,this.hiddenNodes.length=0,this.outputNodes.length=0;for(var s=0,c=e.nodes;s<c.length;s++){var u,a=c[s].uid,l=t.hiddenNode;switch(a<=n&&(l=a<=i?t.inputNode:t.outputNode),u=o.create(l!==t.inputNode),r.set(a,u),l){case t.inputNode:this.inputNodes.push(u);break;case t.outputNode:this.outputNodes.push(u);break;case t.hiddenNode:this.hiddenNodes.push(u)}}return r},e.prototype.setConnections=function(e,t){for(var i=0,n=t.connections;i<n.length;i++){var o=n[i];if(!0===o.enabled){var r=e.get(o.to.uid),s=e.get(o.from.uid);r&&s&&(r.inputs.push(s),r.weights.push(o.weight))}}return this},e}();i.default=n;var o=function(){function e(){this.inputs=null,this.weights=null,this.hasResult=!1,this.value=0}return e.create=function(t){void 0===t&&(t=!0);var i=new e;return!0===t&&(i.inputs=[],i.weights=[]),i},e.prototype.getResult=function(){var e=this.inputs,t=this.weights;if(!0===this.hasResult)return this.value;if(!e||!t)return this.hasResult=!0,this.value;if(e.length!==t.length)return this.hasResult=!1,this.value;for(var i=0,n=0,o=t.length;n<o;++n)i+=t[n]*e[n].getResult();return this.hasResult=!0,this.value=this.activate(i),this.value},e.prototype.clearResult=function(){this.hasResult=!1,this.value=0},e.prototype.activate=function(e){return e>=0?e:.07*e},e}();cc._RF.pop()},{}],Ga:[function(e,t,i){"use strict";cc._RF.push(t,"37861VN57hIP4EbclzMe3Wi","Ga"),Object.defineProperty(i,"__esModule",{value:!0});var n=e("./Neat"),o=e("./Species"),r=function(){function e(){}return e.nextEpochForSingleSpecies=function(t,i){void 0===i&&(i=!1);for(var n=[],o=0,r=t;o<r.length;o++){var s=r[o],c=t[e.getRouletteNum(t.length-1)],u=c.fitness>s.fitness,a=s.genome.crossover(c.genome,u);a.mutate(i),n.push(a)}t.forEach(function(e,t){e.reset(n[t])})},e.nextEpochForMutipleSpecies=function(t,i){if(void 0===i&&(i=!1),!(t.length<=1)){var r=t.length,s=[],c=t[0];s.push(o.default.create(c));for(var u=1;u<r;++u){for(var a=!1,l=0,h=s;l<h.length;l++)if((T=h[l]).try2Put(t[u])){a=!0;break}!1===a&&s.push(o.default.create(t[u]))}for(s.forEach(function(e){return e.evaluateScore()}),s.forEach(function(e){return e.kill(n.default.speciesSurviveRate)}),u=s.length-1;u>=0;--u)s[u].agents.length<=1&&(s[u].dieOut(),s.splice(u,1));if(0!==s.length){var p=0,f=[];s.forEach(function(e){return p+=e.score}),s.sort(function(e,t){return t.score-e.score});for(var d=0,v=t;d<v.length;d++){var g=v[d];if(g.species){var m=(N=(T=g.species).agents[e.getRouletteNum(T.agents.length-1)]).fitness>g.fitness;(y=g.genome.crossover(N.genome,m)).mutate(i),f.push(y)}else{var N,y,T=null,P=Math.random(),w=0;if(p>0)for(var S=0,_=s;S<_.length;S++){var b=_[S];if(P<=(w+=b.score)/p){T=b;break}}else T=s[Math.floor(P*s.length)];if(null!==T)m=(N=T.agents[e.getRouletteNum(T.agents.length-1)]).fitness>g.fitness,(y=g.genome.crossover(N.genome,m)).mutate(i),f.push(y)}}t.forEach(function(e,t){e.reset(f[t])})}else e.nextEpochForSingleSpecies(t,i)}},e.getRouletteNum=function(e){var t=n.default.rNormal(2);return t<.5&&(t=1-t),t=2*(t-.5),Math.floor(t*e)},e}();i.default=r,cc._RF.pop()},{"./Neat":"Neat","./Species":"Species"}],Gene:[function(e,t,i){"use strict";cc._RF.push(t,"8a9e7nwFLJFarfuT565zDFg","Gene"),Object.defineProperty(i,"__esModule",{value:!0}),i.ConnGene=i.NodeGene=void 0;var n=function(){function e(){this.uid=e.invalidID,this.x=0,this.y=0}return e.create=function(t){void 0===t&&(t=-1);var i=new e;return-1!==t&&(i.uid=t),i},e.getNode=function(t){var i=e.nodePool;return t!==e.invalidID&&i[t]?i[t]:i[0]},e.getNewNode=function(){var t=e.nodePool,i=e.create(t.length);return t.push(i),i},e.getMiddleNode=function(t){var i=e.lstMidNodes;return t!==o.invalidInnovNum&&i.has(t)?i.get(t):e.nodePool[0]},e.addMiddleNode=function(t,i){var n=e.lstMidNodes;t===o.invalidInnovNum||n.has(t)||n.set(t,i)},e.invalidID=0,e.nodePool=[e.create(e.invalidID)],e.lstMidNodes=new Map,e}();i.NodeGene=n;var o=function(){function e(){this.innovNum=e.invalidInnovNum,this.enabled=!0,this.weight=0,this.from=null,this.to=null,this.code=""}return e.create=function(t,i){var n=new e;return n.setConnection(t,i),n},e.prototype.setConnection=function(e,t){this.to=t,this.from=e,this.code=this.hash()},e.prototype.getCode=function(){return""===this.code&&(this.code=this.hash()),this.code},e.prototype.clone=function(){var t=new e;return t.setConnection(this.from,this.to),t.innovNum=this.innovNum,t.enabled=this.enabled,t.weight=this.weight,t},e.prototype.hash=function(){return this.from&&this.to?"{"+this.from.uid+", "+this.to.uid+"}":"invalid-code"},e.getInnovNum=function(t){var i=e.lstInnovNums;return i.has(t)?i.get(t):e.invalidInnovNum},e.addInnovNum=function(t){if("invalid-code"!==t){var i=e.lstInnovNums;i.has(t)||i.set(t,e.nextInnovNum++)}},e.getLatestInnovNum=function(){return e.nextInnovNum-1},e.invalidInnovNum=0,e.nextInnovNum=1,e.lstInnovNums=new Map,e}();i.ConnGene=o,cc._RF.pop()},{}],Genome:[function(e,t,i){"use strict";cc._RF.push(t,"2d1d8LG72tG6bvuR++fqggN","Genome"),Object.defineProperty(i,"__esModule",{value:!0});var n=e("./Neat"),o=e("./Gene"),r=function(){function e(){this.inputNum=0,this.outputNum=0,this.nodes=[],this.connections=[]}return e.createPrototype=function(t,i){var n=new e;if(t>0&&i>0){var r=2*e.spaceHalfHeight,s=r/(t+1),c=r/(i+1);n.inputNum=t,n.outputNum=i;for(var u=1;u<=t;++u)(l=o.NodeGene.getNode(u)).uid===o.NodeGene.invalidID&&(l=o.NodeGene.getNewNode()),n.nodes.push(l),l.y=-e.spaceHalfHeight+s*u,l.x=-e.spaceHalfWidth;var a=t+i;for(u=t+1;u<=a;++u){var l;(l=o.NodeGene.getNode(u)).uid===o.NodeGene.invalidID&&(l=o.NodeGene.getNewNode()),n.nodes.push(l),l.y=-e.spaceHalfHeight+c*(u-t),l.x=e.spaceHalfWidth}}return n},e.prototype.distance=function(e){var t=e;if(this===t)return 0;for(var i,o=this.connections.length,r=0,s=t.connections.length,c=0,u=0,a=0,l=0,h=null,p=0,f=null,d=0;r<o&&c<s;)h=this.connections[r],f=t.connections[c],(p=h.innovNum)===(d=f.innovNum)?(l+=Math.abs(h.weight-f.weight),++u,++r,++c):p>d?(++a,++c):(++a,++r);u>0&&(l/=u),i=o-r+(s-c);var v=Math.max(o,s);if(v<n.default.linkEarlyProtection){var g=v/n.default.linkEarlyProtection;v=n.default.lerp(1,n.default.linkEarlyProtection,Math.pow(g,3))}return n.default.c1*i/v+n.default.c2*a/v+n.default.c3*l},e.prototype.crossover=function(t,i){var n,r,s=this,c=t;if(s===c)return this.clone();var u=s.connections.length,a=0,l=c.connections.length,h=0;if(i&&(s=(n=[c,s])[0],c=n[1],u=(r=[l,u])[0],l=r[1]),s.inputNum!==c.inputNum||s.outputNum!==c.outputNum)return this.clone();var p=new e;p.inputNum=this.inputNum,p.outputNum=this.outputNum;for(var f=null,d=0,v=null,g=0;a<u&&h<l;)f=s.connections[a],v=c.connections[h],(d=f.innovNum)===(g=v.innovNum)?(p.connections.push(Math.random()<.5?f.clone():v.clone()),++a,++h):d>g?++h:(p.connections.push(f.clone()),++a);for(;a<u;)p.connections.push(s.connections[a].clone()),++a;for(var m=new Map,N=null,y=null,T=1,P=p.inputNum+p.outputNum;T<=P;++T){var w=o.NodeGene.getNode(T);m.set(T,1),p.nodes.push(w)}for(var S=0,_=p.connections;S<_.length;S++){var b=_[S];N=b.from,y=b.to,!1===m.has(N.uid)&&(m.set(N.uid,1),p.nodes.push(N)),!1===m.has(y.uid)&&(m.set(y.uid,1),p.nodes.push(y))}return p.nodes.sort(function(e,t){return e.uid-t.uid}),p},e.prototype.clone=function(){var t=new e;return t.inputNum=this.inputNum,t.outputNum=this.outputNum,this.nodes.forEach(function(e){return t.nodes.push(e)}),this.connections.forEach(function(e){return t.connections.push(e.clone())}),t},e.prototype.mutate=function(e){var t=Math.random,i=n.default.nodeMutationProb,o=n.default.linkMutationProb,r=this.inputNum+this.outputNum;this.nodes.length-r<n.default.nodeEarlyProtection&&(i=.4),this.connections.length<Math.round(n.default.linkEarlyProtection/4)&&(o=this.connections.length>0?.2:1),!e&&t()<i&&this.mutateNode(),!e&&t()<o&&this.mutateLink(),t()<n.default.weightMutationDitherProb&&this.mutateWeightDitheringly(),t()<n.default.weightMutationRandomProb&&this.mutateWeightRandomly(),this.connections.length>=n.default.linkEarlyProtection&&t()<n.default.linkToggleMutationProb&&this.mutateLinkToggle()},e.prototype.mutateNode=function(){if(!(this.connections.length<=0))for(var t=100,i=this.connections.length-1,r=function(e){return e.innovNum===o.ConnGene.invalidInnovNum&&(o.ConnGene.addInnovNum(e.getCode()),e.innovNum=o.ConnGene.getInnovNum(e.getCode()),!0)};t>0;){var s=n.default.rInt(0,i),c=this.connections[s];if(c&&!0===c.enabled){var u=o.NodeGene.getMiddleNode(c.innovNum);if(u.uid===o.NodeGene.invalidID){var a=.1*e.spaceHalfHeight;(u=o.NodeGene.getNewNode()).x=(c.from.x+c.to.x)/2,u.y=(c.from.y+c.to.y)/2+n.default.rUnit()*a,o.NodeGene.addMiddleNode(c.innovNum,u)}var l=o.ConnGene.create(c.from,u),h=o.ConnGene.create(u,c.to);l.weight=1,l.enabled=!0,h.weight=c.weight,h.enabled=c.enabled,l.innovNum=o.ConnGene.getInnovNum(l.getCode()),h.innovNum=o.ConnGene.getInnovNum(h.getCode()),this.connections.splice(s,1),this.connections.push(l,h),!1===(r(l)&&r(h))&&this.connections.sort(function(e,t){return e.innovNum-t.innovNum});var p=this.nodes.push(u);p>=2&&this.nodes[p-2].uid>u.uid&&this.nodes.sort(function(e,t){return e.uid-t.uid});break}--t}},e.prototype.mutateLink=function(){if(!(this.nodes.length<=1))for(var e=100,t=this.nodes.length-1,i=this.inputNum+this.outputNum,r=this.inputNum,s=function(){var s,u=n.default.rInt(0,t),a=n.default.rInt(0,t);if(u===a)return"continue";if(u<r&&a<r)return"continue";if(u>=r&&u<i&&a>=r&&a<i)return"continue";var l=c.nodes[u],h=c.nodes[a];if(Math.abs(l.x-h.x)<=1e-7)return"continue";l.x>h.x&&(l=(s=[h,l])[0],h=s[1]);var p=o.ConnGene.create(l,h),f=o.ConnGene.getInnovNum(p.getCode()),d=!0;if(f!==o.ConnGene.invalidInnovNum&&(o.NodeGene.getMiddleNode(f).uid!==o.NodeGene.invalidID&&(d=!1),-1!==n.default.binarySearch(c.connections,function(e){return e.innovNum-f})&&(d=!1)),!0===d)return f===o.ConnGene.invalidInnovNum&&(o.ConnGene.addInnovNum(p.getCode()),f=o.ConnGene.getInnovNum(p.getCode())),p.weight=n.default.rUnit()*n.default.weightRandomScalar,p.enabled=!0,p.innovNum=f,c.connections.push(p),p.innovNum!==o.ConnGene.getLatestInnovNum()&&c.connections.sort(function(e,t){return e.innovNum-t.innovNum}),"break";--e},c=this;e>0&&"break"!==s(););},e.prototype.mutateWeightDitheringly=function(){var e=n.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.weight+=n.default.rUnit()*n.default.weightDitherScalar)},e.prototype.mutateWeightRandomly=function(){var e=n.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.weight=n.default.rUnit()*n.default.weightRandomScalar)},e.prototype.mutateLinkToggle=function(){var e=n.default.rInt(0,this.connections.length-1),t=this.connections[e];t&&(t.enabled=!t.enabled)},e.spaceHalfWidth=200,e.spaceHalfHeight=200,e}();i.default=r,cc._RF.pop()},{"./Gene":"Gene","./Neat":"Neat"}],Neat:[function(e,t,i){"use strict";var n;cc._RF.push(t,"97461zxj4dOWLQUem104tXb","Neat"),Object.defineProperty(i,"__esModule",{value:!0}),function(e){e.c1=1,e.c2=1,e.c3=1,e.cp=5,e.speciesSurviveRate=.25,e.nodeEarlyProtection=3,e.linkEarlyProtection=20,e.weightDitherScalar=.2,e.weightRandomScalar=.5,e.nodeMutationProb=.01,e.linkMutationProb=.05,e.linkToggleMutationProb=.001,e.weightMutationDitherProb=.42,e.weightMutationRandomProb=.17,e.rInt=function(e,t){var i;return e>t&&(e=(i=[t,e])[0],t=i[1]),Math.floor(e)+Math.floor(Math.random()*(t-e+1))},e.rUnit=function(){var e=Math.random,t=e();return 0===t?0:t<.5?e()-1:1-e()},e.rNormal=function(e){for(var t=Math.random,i=0,n=0;n<e;++n)i+=t();return i/e},e.lerp=function(e,t,i){return e+(t-e)*i},e.binarySearch=function(e,t){for(var i=0,n=0,o=0,r=e.length-1;o<=r;){if(0===(n=t(e[i=o+r>>>1])))return i;n>0?r=i-1:o=i+1}return-1}}(n||(n={})),i.default=n,cc._RF.pop()},{}],Species:[function(e,t,i){"use strict";cc._RF.push(t,"9b708ws9jVJJascTqrrLGkf","Species"),Object.defineProperty(i,"__esModule",{value:!0});var n=e("./Neat"),o=function(){function e(){this.representative=null,this.agents=[],this.score=0}return e.create=function(t){var i=new e;return i.representative=t,i.representative.species=i,i.agents.push(t),i},e.prototype.try2Put=function(e){return e.genome.distance(this.representative.genome)<=n.default.cp&&(this.agents.push(e),e.species=this,!0)},e.prototype.dieOut=function(){for(var e=0,t=this.agents;e<t.length;e++)t[e].species=null;this.representative.species=null,this.representative=null,this.agents.length=0,this.score=0},e.prototype.evaluateScore=function(){var e=this.agents.length,t=0;if(e>0){for(var i=0,n=0,o=this.agents;n<o.length;n++)i+=o[n].fitness;t=i/e}return this.score=t,t},e.prototype.kill=function(e){for(var t=this,i=this.agents.length-1,n=Math.round(e*i),o=i;o>n;--o)this.agents.pop().species=null;this.agents.length<=0?this.dieOut():-1===this.agents.findIndex(function(e){return e===t.representative})&&(this.representative=this.agents[0])},e}();i.default=o,cc._RF.pop()},{"./Neat":"Neat"}],TetrisRenderer:[function(e,t,i){"use strict";cc._RF.push(t,"97999m4IwpKx4ONMh8aBinm","TetrisRenderer"),Object.defineProperty(i,"__esModule",{value:!0});var n=e("./Tetris"),o=cc._decorator,r=o.ccclass,s=o.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tileArea=null,t.tileFrame=null,t.previewPiece=null,t.scoreNum=null,t.lstTilePrefab=[],t.tetris=null,t.tileLines=null,t.tileNodeLines=null,t.tileNodePools=null,t.nextPieceType=-1,t.score=-1,t}return __extends(t,e),t.prototype.setTetris=function(e){this.tetris=e},t.prototype.init=function(e){this.tetris=e,this.tileLines=[],this.tileNodeLines=[],this.tileNodePools=new Map,this.tileNodePools.set(n.Tetris.eTile.Piece_1,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_2,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_3,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_4,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_5,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_6,new cc.NodePool),this.tileNodePools.set(n.Tetris.eTile.Piece_7,new cc.NodePool);for(var t=0,i=n.Tetris.heightTileNum;t<i;++t)this.tileLines.push(new Array(n.Tetris.widthTileNum).fill(n.Tetris.eTile.Empty));for(t=0,i=n.Tetris.heightTileNum;t<i;++t)this.tileNodeLines.push(new Array(n.Tetris.widthTileNum).fill(null));this.initTileArea()},t.prototype.release=function(){this.tileNodePools&&this.tileNodePools.forEach(function(e){e&&e.size()>0&&e.clear()}),this.tileFrame.destroyAllChildren(),this.previewPiece.destroyAllChildren(),this.tetris=null,this.tileLines=null,this.tileNodeLines=null,this.tileNodePools=null,this.nextPieceType=-1,this.score=-1},t.prototype.lateUpdate=function(){var e=this,t=this.tetris;if(t){var i=t.lines,o=this.tileLines;o.forEach(function(t,n){t.forEach(function(t,o){t!==i[n][o]&&e.setTileOnArea(o,n,i[n][o])})});var r=t.pieceQueue[0];if(r&&!0===r.enable){var s=n.Tetris.heightTileNum-1,c=n.Tetris.widthTileNum-1,u=r.getTilePositions(),a=r.type,l=-1,h=-1;u.forEach(function(t){l=t.x,h=t.y,l>=0&&l<=c&&h>=0&&h<=s&&o[h][l]!==a&&e.setTileOnArea(l,h,a)})}this.updatePreviewPiece(),this.updateScore()}},t.prototype.initTileArea=function(){var e=this.getTileNode(n.Tetris.eTile.Piece_1),t=n.Tetris.heightTileNum*e.height,i=n.Tetris.widthTileNum*e.width,o=cc.v2(-i/2,-t/2);e.destroy(),this.tileFrame.setPosition(o),this.tileArea.setPosition(o);for(var r=-1,s=n.Tetris.widthTileNum;r<=s;++r)for(var c=-1,u=n.Tetris.heightTileNum;c<=u;c+=u+1)(e=this.getTileNode(0)).setPosition(cc.v2(r*e.width,c*e.height)),e.setParent(this.tileFrame);for(r=-1,s=n.Tetris.widthTileNum;r<=s;r+=s+1)for(c=-1,u=n.Tetris.heightTileNum;c<=u;++c)(e=this.getTileNode(0)).setPosition(cc.v2(r*e.width,c*e.height)),e.setParent(this.tileFrame)},t.prototype.setTileOnArea=function(e,t,i){var o=this.tileLines,r=this.tileNodeLines,s=n.Tetris.eTile.Empty,c=o[t][e];if(c!==s&&(this.setTileNode2Pool(c,r[t][e]),r[t][e]=null),i!==s){var u=this.getTileNode(i);u.setPosition(cc.v2(e*u.width,t*u.height)),u.setParent(this.tileArea),r[t][e]=u}o[t][e]=i},t.prototype.updatePreviewPiece=function(){var e=this,t=this.tetris;if(t){var i=t.pieceQueue.find(function(e){return!1===e.enable});if(i){if(this.nextPieceType!==i.type){this.nextPieceType=i.type,this.previewPiece.destroyAllChildren();var o=n.Piece.create().reset(i.type),r=i.getTilePositions(),s=-1,c=-1;r.forEach(function(t){s=t.x,c=t.y;var i=e.getTileNode(o.type);i.setPosition(cc.v2(s*i.width,c*i.height)),i.setParent(e.previewPiece)})}}else this.nextPieceType=n.Tetris.eTile.Empty,this.previewPiece.destroyAllChildren()}},t.prototype.updateScore=function(){var e=this.tetris;e&&this.score!==e.score&&(this.scoreNum.string="Score: "+e.score,this.score=e.score)},t.prototype.getTileNode=function(e){if(e<n.Tetris.eTile.Piece_1&&(e=0),e>n.Tetris.eTile.Piece_7&&(e=0),this.tileNodePools){var t=this.tileNodePools.get(e);if(t&&t.size()>0)return t.get()}return cc.instantiate(this.lstTilePrefab[e])},t.prototype.setTileNode2Pool=function(e,t){if(this.tileNodePools){var i=this.tileNodePools.get(e);if(i&&i.size()<30)return i.put(t),!0}return t.destroy(),!1},__decorate([s(cc.Node)],t.prototype,"tileArea",void 0),__decorate([s(cc.Node)],t.prototype,"tileFrame",void 0),__decorate([s(cc.Node)],t.prototype,"previewPiece",void 0),__decorate([s(cc.Label)],t.prototype,"scoreNum",void 0),__decorate([s([cc.Prefab])],t.prototype,"lstTilePrefab",void 0),__decorate([r],t)}(cc.Component);i.default=c,cc._RF.pop()},{"./Tetris":"Tetris"}],TetrisTest:[function(e,t,i){"use strict";cc._RF.push(t,"3da015Q4tZGe43ZG09abj2g","TetrisTest"),Object.defineProperty(i,"__esModule",{value:!0});var n,o=e("./neat/Ga"),r=e("./neat/Agent"),s=e("./neat/Genome"),c=e("./tetris/Tetris"),u=e("./tetris/TetrisRenderer");(function(e){e[e.SingleSpecies=1]="SingleSpecies",e[e.MutipleSpecies=2]="MutipleSpecies"})(n||(n={}));var a=cc._decorator,l=a.ccclass,h=a.property,p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.pen=null,t.genText=null,t.speedUpBtn=null,t}return __extends(t,e),t.prototype.onLoad=function(){cc.dynamicAtlasManager.enabled=!0,cc.dynamicAtlasManager.textureSize=1024,cc.dynamicAtlasManager.maxAtlasCount=1},t.prototype.start=function(){this.TetrisTest(n.MutipleSpecies)},t.prototype.TetrisTest=function(e){var t=this;void 0===e&&(e=n.SingleSpecies);var i=[],a=1,l=!1,h=c.Tetris.create();h.state=c.Tetris.eState.Start;var p=cc.find("Canvas/TetrisRenderer").getComponent(u.default);p&&p.init(h);for(var f=c.Tetris.widthTileNum+5+1,d=0;d<150;++d)i.push(r.default.create(s.default.createPrototype(f,4)));i.forEach(function(e){for(var t=0;t<64;++t)e.genome.mutateLink()});var v={testFunc:null};cc.tween(this.node).delay(.5).call(function(){cc.tween(t.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){v.testFunc&&v.testFunc()}),cc.delayTime(0)))).start()}).start(),this.speedUpBtn.node.on("click",function(){if(v.testFunc)for(var e=0;e<500;++e)v.testFunc()});var g=1,m=function(e,t){var i=e.lines,n=new Array(f).fill(0),o=c.Tetris.eTile.Empty;i.forEach(function(e,t){e.forEach(function(e,i){e!==o&&(n[i]=t+1)})});var r=e.pieceQueue[0];r&&!0===r.enable&&(n[s=f-5-1]=r.x,n[s+1]=r.y,n[s+2]=r.rot,n[s+3]=r.type);var s,u=e.pieceQueue.find(function(e){return!1===e.enable});u&&!1===u.enable&&(n[4+(s=f-5-1)]=u.type,n[s+5]=1);var a=t.react.apply(t,n);if(a[0]>.5)for(var l=2*(a[0]-.5),h=Math.round(cc.misc.lerp(1,5,l)),p=0;p<h;++p)c.Control.pressKeyUp(e);if(a[1]>.5&&c.Control.pressKeyDown(e),a[2]-a[3]>=.1)for(l=Math.min(a[2]-a[3],1),h=Math.round(cc.misc.lerp(1,3,l)),p=0;p<h;++p)c.Control.pressKeyLeft(e);if(a[3]-a[2]>=.1)for(l=Math.min(a[3]-a[2],1),h=Math.round(cc.misc.lerp(1,3,l)),p=0;p<h;++p)c.Control.pressKeyRight(e);e.step()};v.testFunc=function(){if(h.state!==c.Tetris.eState.Idle){if(i.forEach(function(e){for(var t=h.clone(),i=c.Tetris.eTile.Empty;t.state!==c.Tetris.eState.ScanLines;)m(t,e);t.lines.forEach(function(t,n){var o=c.Tetris.heightTileNum-n,r=0;t.forEach(function(e){e===i&&++r});var s=Math.pow(o,1.3);if(0===r&&(e.fitness+=1.6*s),r===c.Tetris.widthTileNum)e.fitness+=1.2*s;else{var u=c.Tetris.widthTileNum,a=(u-r)/u;e.fitness+=2.9*a*s}});for(var n=0,o=0,r=c.Tetris.widthTileNum;o<r;++o)for(var s=0,u=t.lines,a=c.Tetris.heightTileNum-1;a>=0;--a)u[a][o]!==i?0===s&&(s=a+1):s>0&&++n;e.fitness+=-100*n}),1===g&&(i.sort(function(e,t){return t.fitness-e.fitness}),t.displayANN(i[0]),t.genText.string="Generation: "+a,g=2),2===g){if(h.state!==c.Tetris.eState.ScanLines)return void m(h,i[0]);g=3}if(3===g){switch(h.score>=6e3&&(l=!0),e){case n.SingleSpecies:o.default.nextEpochForSingleSpecies(i,l);break;case n.MutipleSpecies:o.default.nextEpochForMutipleSpecies(i,l)}g=1,a+=1}h.step()}else h.state=c.Tetris.eState.Start}},t.prototype.playGameTest=function(){var e=this,t=c.Tetris.create(),i=cc.find("Canvas/TetrisRenderer").getComponent(u.default);i&&i.init(t),cc.systemEvent.on("keydown",function(e){e.keyCode===cc.macro.KEY.up&&c.Control.pressKeyUp(t),e.keyCode===cc.macro.KEY.down&&c.Control.pressKeyDown(t),e.keyCode===cc.macro.KEY.left&&c.Control.pressKeyLeft(t),e.keyCode===cc.macro.KEY.right&&c.Control.pressKeyRight(t)}),cc.tween(this.node).delay(1.5).call(function(){t.state=c.Tetris.eState.Start}).call(function(){cc.tween(e.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){return t.step()}),cc.delayTime(.5)))).start()}).start()},t.prototype.displayANN=function(e){var t=this.pen,i=e.genome;t.clear(),i.connections.forEach(function(e){!0===e.enabled&&(t.moveTo(e.from.x,e.from.y),t.lineTo(e.to.x,e.to.y))}),t.stroke(),i.nodes.forEach(function(e){t.circle(e.x,e.y,5)}),t.fill()},__decorate([h(cc.Graphics)],t.prototype,"pen",void 0),__decorate([h(cc.Label)],t.prototype,"genText",void 0),__decorate([h(cc.Button)],t.prototype,"speedUpBtn",void 0),__decorate([l],t)}(cc.Component);i.default=p,cc._RF.pop()},{"./neat/Agent":"Agent","./neat/Ga":"Ga","./neat/Genome":"Genome","./tetris/Tetris":"Tetris","./tetris/TetrisRenderer":"TetrisRenderer"}],Tetris:[function(e,t,i){"use strict";var n,o;cc._RF.push(t,"fa07dhbXk1HRpx7/EmLlYcI","Tetris"),Object.defineProperty(i,"__esModule",{value:!0}),i.peiceShape=i.Control=i.Piece=i.Tetris=void 0,function(e){e[e.Empty=0]="Empty",e[e.Piece_1=1]="Piece_1",e[e.Piece_2=2]="Piece_2",e[e.Piece_3=3]="Piece_3",e[e.Piece_4=4]="Piece_4",e[e.Piece_5=5]="Piece_5",e[e.Piece_6=6]="Piece_6",e[e.Piece_7=7]="Piece_7"}(n||(n={})),function(e){e[e.Idle=0]="Idle",e[e.Start=1]="Start",e[e.PieceComing=2]="PieceComing",e[e.PieceSlipping=3]="PieceSlipping",e[e.ScanLines=4]="ScanLines",e[e.GameOver=5]="GameOver"}(o||(o={}));var r=function(){function e(){this.pieceQueue=[],this.lines=new Array,this.state=e.eState.Idle,this.bag7=new Array,this.slipDown=0,this.rotTimes=0,this.shiftDir=0,this.score=0}return e.create=function(){var t=new e;return t.reset(),t},e.prototype.clone=function(){var t=new e;return this.pieceQueue.forEach(function(e){t.pieceQueue.push(e.clone())}),this.lines.forEach(function(e){t.lines.push(e.map(function(e){return e}))}),t.state=this.state,t.slipDown=this.slipDown,t.rotTimes=this.rotTimes,t.shiftDir=this.shiftDir,t.score=this.score,t},e.prototype.reset=function(){this.pieceQueue.length=0,this.lines.length=0,this.state=e.eState.Idle,this.resetPlayerOperations(),this.score=0;for(var t=0,i=e.heightTileNum;t<i;++t)this.lines.push(this.newEmptyLine());return this},e.prototype.step=function(){switch(this.state){case e.eState.Idle:break;case e.eState.Start:this.reset(),this.addPieceInQueue(),this.addPieceInQueue(),this.state=e.eState.PieceComing,this.step();break;case e.eState.PieceComing:this.initSlippingPiece(),this.resetPlayerOperations(),this.state=e.eState.PieceSlipping;break;case e.eState.PieceSlipping:var t=this.pieceQueue[0];t&&!0===t.enable&&(this.dealWithInputs(),t.slip(),!0===this.collideOrNot(t)&&(t.raise(),this.putPieceOn(t),this.removeSlippingPiece(),this.addPieceInQueue(),this.state=e.eState.ScanLines));break;case e.eState.ScanLines:var i=this.scanLines();this.score+=this.countScores(i),this.clearLines(i),!0===this.isGameOver()?this.state=e.eState.GameOver:this.state=e.eState.PieceComing,this.step();break;case e.eState.GameOver:this.state=e.eState.Idle,this.step()}},e.prototype.dealWithInputs=function(){if(this.state===e.eState.PieceSlipping){var t=this.pieceQueue[0];if(t&&!0===t.enable){for(var i=this.rotTimes%4,n=0;n<i;++n)this.try2Rotate(t);for(i=Math.min(Math.abs(this.shiftDir),Math.round(e.widthTileNum/2)),n=0;n<i;++n)this.shiftDir>0?this.try2ShiftRight(t):this.try2ShiftLeft(t);this.slipDown>=1&&(t.slip(),!0===this.collideOrNot(t)&&t.raise()),this.resetPlayerOperations()}}},e.prototype.newEmptyLine=function(){return new Array(e.widthTileNum).fill(e.eTile.Empty)},e.prototype.scanLines=function(){var t=[];return this.lines.forEach(function(i,n){-1===i.findIndex(function(t){return t===e.eTile.Empty})&&t.push(n)}),t},e.prototype.clearLines=function(e){for(var t=this,i=this.lines,n=e.length-1;n>=0;--n)i.splice(e[n],1);e.forEach(function(){i.push(t.newEmptyLine())})},e.prototype.countScores=function(t){for(var i=0,n=t.length-1,o=0;o<=n;++o)o+3<=n&&t[o]+3===t[o+3]?(i+=e.scoreTetris,o+=3):o+2<=n&&t[o]+2===t[o+2]?(i+=e.scoreTriple,o+=2):o+1<=n&&t[o]+1===t[o+1]?(i+=e.scoreDouble,o+=1):i+=e.scoreSingle;return i},e.prototype.try2Rotate=function(t){if(t.rotate(),!0===this.collideOrNot(t)){var i=t.getTilePositions(),n=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,r=t.x;return i.forEach(function(e){e.x<n&&(n=e.x),e.x>o&&(o=e.x)}),n<0&&(t.x+=Math.abs(n),!1===this.collideOrNot(t))||(o>e.widthTileNum-1&&(t.x+=o-e.widthTileNum-1,!1===this.collideOrNot(t))||(t.x=r,t.rotateUndo(),!1))}return!0},e.prototype.try2ShiftLeft=function(e){return e.shiftLeft(),!0!==this.collideOrNot(e)||(e.shiftRight(),!1)},e.prototype.try2ShiftRight=function(e){return e.shiftRight(),!0!==this.collideOrNot(e)||(e.shiftLeft(),!1)},e.prototype.collideOrNot=function(e){return e.checkCollision(this)},e.prototype.putPieceOn=function(e){e.putOn(this)},e.prototype.isGameOver=function(){return-1!==this.lines[this.lines.length-1].findIndex(function(t){return t>e.eTile.Empty})},e.prototype.initSlippingPiece=function(){var t=this.pieceQueue[0];if(t)for(t.enable=!0,t.x=Math.floor((e.widthTileNum-1)/2),t.y=e.heightTileNum-2;!0===this.collideOrNot(t);)t.y+=1},e.prototype.resetPlayerOperations=function(){this.slipDown=0,this.rotTimes=0,this.shiftDir=0},e.prototype.addPieceInQueue=function(){var t,i=s.create(),n=this.bag7;if(0===n.length){n.push(e.eTile.Piece_1),n.push(e.eTile.Piece_2),n.push(e.eTile.Piece_3),n.push(e.eTile.Piece_4),n.push(e.eTile.Piece_5),n.push(e.eTile.Piece_6),n.push(e.eTile.Piece_7);for(var o=n.length-1;o>0;o--){var r=Math.floor(Math.random()*(o+1));t=[n[r],n[o]],n[o]=t[0],n[r]=t[1]}}i.reset(n.pop()),this.pieceQueue.push(i)},e.prototype.removeSlippingPiece=function(){this.pieceQueue.length>0&&(this.pieceQueue.shift().enable=!1)},e.widthTileNum=10,e.heightTileNum=20,e.scoreSingle=40,e.scoreDouble=100,e.scoreTriple=300,e.scoreTetris=1200,e.eTile=n,e.eState=o,e}();i.Tetris=r;var s=function(){function e(){this.enable=!1,this.type=e.eTile.Empty,this.rot=0,this.x=0,this.y=0}return e.create=function(){var t=new e;return t.reset(e.eTile.Empty),t},e.prototype.clone=function(){var t=new e;return t.enable=this.enable,t.type=this.type,t.rot=this.rot,t.x=this.x,t.y=this.y,t},e.prototype.reset=function(e){return this.enable=!1,this.type=e,this.rot=0,this},e.prototype.getTilePositions=function(){var e=new Array,t=this.getPieceShape();if(t)for(var i=this.x+c.offset.x,n=this.y+c.offset.y,o=0,r=t.length;o<r;++o)for(var s=t[o],u=0,a=s.length;u<a;++u)1===s[u]&&e.push({x:i+u,y:n+o});return e},e.prototype.checkCollision=function(e){for(var t=r.heightTileNum-1,i=r.widthTileNum-1,n=r.eTile.Empty,o=e.lines,s=-1,c=-1,u=0,a=this.getTilePositions();u<a.length;u++){var l=a[u];if(s=l.x,(c=l.y)<0)return!0;if(s<0||s>i)return!0;if(c<=t&&o[c][s]!==n)return!0}return!1},e.prototype.putOn=function(e){for(var t=r.heightTileNum-1,i=r.widthTileNum-1,n=e.lines,o=this.type,s=-1,c=-1,u=0,a=this.getTilePositions();u<a.length;u++){var l=a[u];s=l.x,c=l.y,s>=0&&s<=i&&c>=0&&c<=t&&(n[c][s]=o)}},e.prototype.getPieceShape=function(){return c.shape[this.type][this.rot]},e.prototype.rotate=function(){this.rot+=1,this.rot>3&&(this.rot=0)},e.prototype.rotateUndo=function(){this.rot+=-1,this.rot<0&&(this.rot=3)},e.prototype.shiftRight=function(){this.x+=1},e.prototype.shiftLeft=function(){this.x+=-1},e.prototype.raise=function(){this.y+=1},e.prototype.slip=function(){this.y+=-1},e.eTile=n,e}();i.Piece=s;var c,u=function(){function e(){}return e.pressKeyUp=function(e){e.state===r.eState.PieceSlipping&&(e.rotTimes+=1,e.dealWithInputs())},e.pressKeyDown=function(e){e.state===r.eState.PieceSlipping?(e.slipDown=1,e.dealWithInputs()):e.state===r.eState.Idle&&(e.state=r.eState.Start)},e.pressKeyLeft=function(e){e.state===r.eState.PieceSlipping&&(e.shiftDir+=-1,e.dealWithInputs())},e.pressKeyRight=function(e){e.state===r.eState.PieceSlipping&&(e.shiftDir+=1,e.dealWithInputs())},e}();i.Control=u,function(e){e.shape=[[],[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],[[[0,0,0],[1,1,1],[1,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1,0],[0,1,0],[0,1,0]]],[[[0,0,0],[1,1,1],[0,0,1]],[[0,1,1],[0,1,0],[0,1,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[1,1,0]]],[[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]],[[0,0,0],[0,1,1],[0,1,1]]],[[[0,0,0],[1,1,0],[0,1,1]],[[0,0,1],[0,1,1],[0,1,0]],[[1,1,0],[0,1,1],[0,0,0]],[[0,1,0],[1,1,0],[1,0,0]]],[[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[1,1,0],[0,1,0]]],[[[0,0,0],[0,1,1],[1,1,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,0,0],[1,1,0],[0,1,0]]]],e.offset={x:-1,y:-1}}(c=i.peiceShape||(i.peiceShape={})),cc._RF.pop()},{}],XorTest:[function(e,t,i){"use strict";cc._RF.push(t,"040f0WJ7Z5JT7VesOvVB/qL","XorTest"),Object.defineProperty(i,"__esModule",{value:!0});var n,o=e("./neat/Ga"),r=e("./neat/Agent"),s=e("./neat/Genome");(function(e){e[e.SingleSpecies=1]="SingleSpecies",e[e.MutipleSpecies=2]="MutipleSpecies"})(n||(n={}));var c=cc._decorator,u=c.ccclass,a=(c.property,function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.pen=null,t}return __extends(t,e),t.prototype.onLoad=function(){cc.game.setFrameRate(50),this.pen=this.node.addComponent(cc.Graphics),this.pen.strokeColor=cc.Color.GREEN,this.pen.fillColor=cc.Color.GREEN,this.pen.lineWidth=2},t.prototype.start=function(){this.xorTest(n.MutipleSpecies)},t.prototype.xorTest=function(e){var t=this;void 0===e&&(e=n.SingleSpecies);for(var i=[],c=1,u=0;u<50;++u)i.push(r.default.create(s.default.createPrototype(2,1)));var a={testFunc:null},l=cc.tween(this.node).then(cc.repeatForever(cc.sequence(cc.callFunc(function(){a.testFunc&&a.testFunc()}),cc.delayTime(0)))).start();a.testFunc=function(){for(var r=0,s=[0,0,0,0],u=0,a=i;u<a.length;u++){var h=a[u];s[0]=h.react(0,0)[0],s[1]=h.react(0,1)[0],s[2]=h.react(1,0)[0],s[3]=h.react(1,1)[0],r=0,r+=Math.pow(s[0]-0,2),r+=Math.pow(s[1]-1,2),r+=Math.pow(s[2]-1,2),r+=Math.pow(s[3]-0,2),r+=1e-7,h.fitness=1/r}i.sort(function(e,t){return t.fitness-e.fitness});var p=i[0],f=p.fitness>=1e5;if((c%10==1||f)&&(console.log("------------------------"),console.log("generation: "+c.toString()),console.log("best genome, XOR problem [0, 0 -> "+p.react(0,0)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [0, 1 -> "+p.react(0,1)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [1, 0 -> "+p.react(1,0)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),console.log("best genome, XOR problem [1, 1 -> "+p.react(1,1)[0].toFixed(6)+"]","connections: "+p.genome.connections.length+"."),t.displayANN(p)),f)return console.log("------------------------"),console.log("end."),void(l&&(l.stop(),l=null));switch(e){case n.SingleSpecies:o.default.nextEpochForSingleSpecies(i);break;case n.MutipleSpecies:o.default.nextEpochForMutipleSpecies(i)}c+=1}},t.prototype.displayANN=function(e){var t=this.pen,i=e.genome;t.clear(),i.connections.forEach(function(e){!0===e.enabled&&(t.moveTo(e.from.x,e.from.y),t.lineTo(e.to.x,e.to.y))}),t.stroke(),i.nodes.forEach(function(e){t.circle(e.x,e.y,5)}),t.fill()},__decorate([u],t)}(cc.Component));i.default=a,cc._RF.pop()},{"./neat/Agent":"Agent","./neat/Ga":"Ga","./neat/Genome":"Genome"}]},{},["TetrisTest","XorTest","Agent","Ann","Ga","Gene","Genome","Neat","Species","Tetris","TetrisRenderer"]);